# Flowmate Nuxt Integration

A Nuxt.js plugin that provides seamless integration with Flowmate, enabling real-time session management and interactive content experiences.

## Features

- **Real-time Session Management**: Connect to Flowmate sessions for live content updates
- **Interactive Block Navigation**: Automatic scrolling and highlighting of active content blocks
- **Click Tracking**: Monitor user interactions with flex-sections
- **Dual Configuration Support**: License key (preferred) or Firebase credentials (legacy)
- **TypeScript Support**: Full TypeScript support with proper type definitions
- **Automatic Setup**: Server handlers and client plugins are automatically configured

## Installation

```bash
npm install @checkmatecph/flowmate-nuxt-integration
# or
yarn add @checkmatecph/flowmate-nuxt-integration
# or
pnpm add @checkmatecph/flowmate-nuxt-integration
```

## Configuration

### Option 1: License Key (Recommended)

The license key approach is the preferred method and will be the only supported configuration in future versions.

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  runtimeConfig: {
    flowmate: {
      licenseKey: process.env.NUXT_FLOWMATE_LICENSE_KEY
    }
  }
})
```

Set your environment variable:
```bash
# .env
NUXT_FLOWMATE_LICENSE_KEY=your_license_key_here
```

### Option 2: Firebase Credentials (Deprecated)

⚠️ **Warning**: Firebase credentials configuration will be deprecated and removed in future versions. Please migrate to the license key approach.

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  runtimeConfig: {
    public: {
      flowmatePlugins: {
        firebase: {
          apiKey: "your-api-key",
          authDomain: "your-project.firebaseapp.com",
          databaseURL: "https://your-project-default-rtdb.firebaseio.com",
          projectId: "your-project-id",
          storageBucket: "your-project.appspot.com",
          messagingSenderId: "123456789",
          appId: "your-app-id"
        }
      }
    }
  }
})
```

## Usage

### 1. Add the Plugin to Your Nuxt App

The plugin is automatically registered when you install the package. No additional configuration is needed in your Nuxt modules. The plugin automatically sets up server handlers and client-side functionality for seamless integration.

### 2. Use the Plugin in Your Components

```vue
<template>
  <div>
    <div 
      v-for="(block, index) in context" 
      :key="index"
      :data-index="index"
      class="flex-section"
    >
      <!-- Your content here -->
      <h2>{{ block.title }}</h2>
      <p>{{ block.content }}</p>
    </div>
  </div>
</template>

<script setup>
const { $readSession } = useNuxtApp()

// Reactive references for Flowmate data
const context = ref([])
const activeBlockIndex = ref(0)

// Initialize Flowmate session
onMounted(() => {
  const sessionId = 'your-session-id' // Get this from your Flowmate integration
  $readSession(sessionId, context, activeBlockIndex)
})
</script>

<style>
.flex-section {
  /* Your styles */
}

.fm-active {
  /* Styles for active block */
  border: 2px solid #007bff;
  background-color: #f8f9fa;
}
</style>
```

### 3. Session Management

The plugin automatically:
- Connects to the Flowmate session using the provided session ID
- Listens for real-time updates to session context
- Tracks active block index changes
- Scrolls to active blocks automatically
- Adds `fm-active` class to the currently active block

### 4. Click Tracking

The plugin automatically tracks clicks on elements with the `flex-section` class and sends messages to the parent window:

```javascript
// Message sent to parent window on flex-section click
{
  type: 'fmBlockClick',
  data: { index: targetIndex }
}
```

## API Endpoints

The plugin automatically creates the following API endpoints when installed:

- `/api/flowmate/session` - Session management endpoint for license key authentication
- `/api/flowmate/**` - Legacy WordPress proxy endpoint (deprecated)

These endpoints are automatically registered and available immediately after plugin installation.

## Migration Guide

### From Firebase to License Key

1. **Remove Firebase configuration**:
   ```typescript
   // Remove this from nuxt.config.ts
   runtimeConfig: {
     public: {
       flowmatePlugins: {
         firebase: { /* ... */ }
       }
     }
   }
   ```

2. **Add license key configuration**:
   ```typescript
   // Add this to nuxt.config.ts
   runtimeConfig: {
     flowmate: {
       licenseKey: process.env.NUXT_FLOWMATE_LICENSE_KEY
     }
   }
   ```

3. **Set environment variable**:
   ```bash
   NUXT_FLOWMATE_LICENSE_KEY=your_license_key_here
   ```

## Requirements

- **Nuxt**: ^3.13.2 || ^4.0.0
- **Firebase**: ^11.0.1 || ^12.0.0 (for legacy support)
- **Node.js**: 18+ (recommended)

## Development

```bash
# Install dependencies
npm install

# Build the plugin
npm run build
```

The plugin automatically handles:
- Server handler registration for API endpoints
- Client-side plugin injection for Firebase initialization
- Proper file resolution and build process

## API Reference

### `$readSession(sessionId, context, activeBlockIndex)`

Initializes a Flowmate session connection.

**Parameters:**
- `sessionId` (string): The Flowmate session identifier
- `context` (ref): Reactive reference for session context data
- `activeBlockIndex` (ref): Reactive reference for active block index

**Returns:** Promise that resolves when the session is initialized

## Troubleshooting

### Common Issues

1. **"Missing license key" error**
   - Ensure `NUXT_FLOWMATE_LICENSE_KEY` environment variable is set
   - Check that the license key is valid

2. **Session connection fails**
   - Verify the session ID is correct
   - Check network connectivity to Flowmate servers
   - Ensure your license key has access to the session

3. **Firebase initialization errors**
   - Verify Firebase configuration is correct
   - Check Firebase project settings and database rules

### Debug Mode

Enable debug logging by setting the environment variable:
```bash
DEBUG=flowmate:*
```

## Support

- **Issues**: [Bitbucket Issues](https://bitbucket.org/CheckmateDev/flowmate-nuxt-integration/issues)
- **Repository**: [Bitbucket Repository](https://bitbucket.org/CheckmateDev/flowmate-nuxt-integration)

## License

ISC License - see [LICENSE](LICENSE) file for details.

## Changelog

### v1.2.1
- Fixed server handler registration for proper plugin functionality
- Improved build process and file resolution
- Enhanced plugin integration with Nuxt

### v1.2.0
- Added license key configuration support
- Deprecated Firebase credentials configuration
- Improved error handling and logging
- Enhanced TypeScript support

### v1.1.0
- Initial release with Firebase support
- Basic session management
- Click tracking functionality
