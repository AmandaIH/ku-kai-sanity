// @ts-nocheck
import { getQuery, defineEventHandler, proxyRequest } from 'h3';
import { joinURL } from "ufo";
/**
 * @deprecated v1.2.0
 * This is (probably) not anymore but is kept in the 1.x branch for legacy reasons.
 */
export default defineEventHandler(async (e) => {
    const backendUrl = e.context.nitro.runtimeConfig.private.backendUrl;
    const query = getQuery(e);
    const allowed_query_params = [
        'acf_content', 'acf_format', 'lazy', 'single', 'path', 'cmv', 'id', 'ids', '_fields', 'location', 'lang', 'nocache', 'include', 'types', 'per_page', 'page'
    ];
    const blacklisted_keywords = [
        'wp-config.php', 'wp-admin', 'admin-ajax.php', 'wp-cron.php', 'index.php', 'composer.json', 'package.json', 'style.css', 'functions.php', 'wp-include', 'wp-login', 'wp-login.php'
    ];
    let invalidRequest = false;
    // Remove any invalid query params.
    Object.keys(query).forEach(key => {
        if (!allowed_query_params.includes(key) || blacklisted_keywords.includes(query[key]) || blacklisted_keywords.includes(query[key])) {
            delete query[key];
        }
        for (const keyword of blacklisted_keywords) {
            if (query[key] && query[key].includes(keyword)) {
                invalidRequest = true;
                delete query[key];
            }
        }
    });
    const slug = e.context.params._;
    if (!slug.startsWith('wp-json/')) {
        invalidRequest = true;
    }
    if (invalidRequest) {
        return [];
    }
    const targetUrl = joinURL(backendUrl, slug) + '?' + new URLSearchParams(query).toString();
    return proxyRequest(e, targetUrl);
});
