// @ts-nocheck
import { initializeApp } from "firebase/app";
import { getDatabase, ref, onValue } from "firebase/database";
import { defineNuxtPlugin, useRuntimeConfig } from "nuxt/app";
export default defineNuxtPlugin((nuxtApp) => {
    const readSession = async (sessionId, context, activeBlockIndex) => {
        if (!sessionId) {
            return;
        }
        // Add click event lister to the document and log when a flex-section is clicked.
        document.addEventListener('click', (event) => {
            if (event.target.closest('.flex-section')) {
                // We need to also log the index of the flex-section.
                const targetIndex = event.target.closest('.flex-section').dataset.index;
                window.parent.postMessage({ type: 'fmBlockClick', data: { index: targetIndex } }, '*' // or specify origin instead of '*'
                );
            }
        });
        const config = useRuntimeConfig();
        // Legacy flowmate config handling.
        let firebaseConfig;
        if (config.public?.flowmatePlugins?.firebase) {
            firebaseConfig = config.public.flowmatePlugins.firebase;
        }
        else {
            // Get config from the api/flowmate/session endpoint.
            firebaseConfig = await new Promise(async (resolve, reject) => {
                try {
                    const response = await fetch('/api/flowmate/session?sessionId=' + sessionId);
                    const data = await response.json();
                    resolve(data);
                }
                catch (err) {
                    reject(err);
                }
            });
        }
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbContext = ref(db, 'sessions/' + sessionId + '/context');
        onValue(dbContext, (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                context.value = data;
            }
        });
        const activeBlockIndexContext = ref(db, 'sessions/' + sessionId + '/activeBlockIndex');
        onValue(activeBlockIndexContext, (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                activeBlockIndex.value = data;
                // Scroll to block.
                const block = document.querySelector(`main [data-index="${activeBlockIndex.value}"]`);
                if (block) {
                    document.querySelectorAll('.flex-section').forEach((section) => {
                        section.classList.remove('fm-active');
                    });
                    // Add active class to the block
                    block.classList.add('fm-active');
                    window.scrollTo({
                        top: block.offsetTop - 100,
                        behavior: 'smooth',
                    });
                }
            }
        });
    };
    return {
        provide: {
            readSession: (sessionId, context, activeBlockIndex) => readSession(sessionId, context, activeBlockIndex)
        }
    };
});
