// @ts-nocheck
import { getQuery, defineEventHandler, setResponseStatus } from 'h3';
export default defineEventHandler(async (e) => {
    const licenseKey = e.context.nitro.runtimeConfig.flowmate?.licenseKey;
    const firebaseConfig = e.context.nitro.runtimeConfig.flowmate?.firebase;
    if (firebaseConfig) {
        return firebaseConfig;
    }
    if (!licenseKey) {
        setResponseStatus(e, 401);
        return {
            error: 'Missing license key',
            firebaseConfig
        };
    }
    else {
        const sessionId = getQuery(e).sessionId;
        if (!sessionId) {
            setResponseStatus(e, 400);
            return {
                error: 'Missing sessionId parameter'
            };
        }
        try {
            const response = await fetch(`https://app.flowmate.dk/api/v1/sessions/${sessionId}`, {
                method: 'GET',
                headers: {
                    "X-Flowmate-License-Key": licenseKey,
                    "X-Flowmate-Session-Id": sessionId
                }
            });
            if (!response.ok) {
                // Try to parse error message from response, fallback to status text
                let errorMsg = `Request failed with status ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData?.message || errorMsg;
                }
                catch (err) {
                    // Ignore JSON parse error, use default errorMsg
                }
                setResponseStatus(e, response.status);
                return {
                    error: errorMsg,
                    status: response.status
                };
            }
            const data = await response.json();
            return data;
        }
        catch (error) {
            setResponseStatus(e, 500);
            return {
                error: error?.message || 'Unknown error occurred while fetching session data'
            };
        }
    }
});
